# Singing Bowl Tuner (Android)

Профессиональный офлайн‑тюнер поющих чаш. Приложение работает на Android (минимум Android 8 / SDK 26), снимает звук с микрофона в реальном времени, выделяет устойчивую основную частоту, переводит её в ближайшую ноту и центы, и позволяет сохранять профили чаш.

## Tech decision
- **Stack:** Нативный Android (Kotlin, Jetpack Compose) для минимальной задержки работы с `AudioRecord` и точного контроля DSP. Compose упрощает быстрые итерации UI без веса движка Flutter. AGP 8.x + Gradle 8.4.
- **Целевая дискретизация:** 48 kHz (поддерживаются 44.1/48 kHz при необходимости), `AudioRecord` с источником `UNPROCESSED` для минимальных искажений.
- **Алгоритмы:** реализация YIN (с расширением под послезвучие), сглаживание по времени для устойчивых значений, детектор уровня/клиппинга для фильтрации слишком слабых/шумных кадров. Архитектура допускает добавление MPM/HPS или спектральных методов для обертонов.

## Минимальные возможности (MVP)
- Главный экран: текущая частота, ближайшая нота, отклонение в центах, индикатор уверенности и предупреждения о шуме/тихом сигнале. Переключатель записи с микрофона.
- Калибровка A4: слайдер 430–450 Hz с сохранением в `DataStore`.
- Сохранение профилей чаш: имя, зафиксированная частота, нота и центы, список сохранённых профилей.
- Все вычисления локально, офлайн.

## Архитектура
- **audio** — захват `AudioRecord` в поток `Flow<FloatArray>`.
- **dsp** — `YinPitchDetector`, `PitchSmoother`, `SignalQualityEstimator`, `NoteConverter`.
- **data** — репозитории `DataStore` для настроек калибровки и списка чаш (JSON через Kotlin serialization).
- **ui** — Compose‑экран тюнера, `TunerViewModel` организует поток: аудио → детекция → сглаживание → отображение/сохранение.

## Алгоритмы и параметры
- Окно: по умолчанию 2048 сэмплов @ 48 kHz (~42.6 мс). Подготовлено к экспериментам с hop size и альтернативными окнами.
- YIN: порог отклонения 0.12, параболическая интерполяция лага, выдаёт частоту и метрику ясности.
- Сглаживание: экспоненциальное (константа ~250 мс) для подавления дрожания и флуктуаций послезвучия.
- Фильтрация сигнала: RMS‑оценка шумового пола и проверка клиппинга. Предупреждения отображаются пользователю.
- Частота → нота: настраиваемая A4, расчёт ближайшей ноты и центов.

## Сборка и запуск
1. Установить JDK 17 и Android SDK (API 34 + build‑tools 34.x). На CI используется Gradle 8.4.
2. Собрать:
   ```bash
   gradle assembleDebug
   ```
3. Запустить на устройстве/эмуляторе:
   ```bash
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   ```
4. Разрешить доступ к микрофону при первом запуске.

Примечание: в офлайн-среде используйте системную команду `gradle`; при наличии сети Gradle Wrapper можно сгенерировать через `gradle wrapper --gradle-version 8.4`.

## Прогресс
- ✔️ Репозиторий очищен от прежнего Flutter‑кода, добавлен нативный Android‑проект.
- ✔️ Реализованы базовые аудио‑захват, YIN‑детектор, сглаживание и перевод частоты в ноту.
- ✔️ Добавлены юнит‑тесты для детектора и конвертера нот, DataStore для калибровки и списка чаш.
- ⏭️ Следующие шаги: добавить анализ обертонов (HPS/cepstrum), полосу пропускания/фильтры для подавления шума, UI‑индикатор стройности, профилирование задержек.

## Как использовать тюнер
1. Запустите приложение и включите микрофон кнопкой «Вкл/выкл».
2. Ударьте в чашу и подождите, пока частота стабилизируется — значение частоты и ноты появится крупным шрифтом.
3. При необходимости скорректируйте A4 (430–450 Hz).
4. Введите имя чаши и сохраните профиль; список профилей доступен ниже на экране.

